# Metricon Analytics — Список проблем

> **ВАЖНО:** При исправлении любой проблемы — ОБЯЗАТЕЛЬНО обнови статус в этом файле!
> Меняй `[ ]` на `[x]` и добавляй дату исправления.
> Последнее обновление: 2026-02-08

---

## Критичные

### 1. Билд сломан — TypeScript ошибка
- **Статус:** `[ ]` Не исправлено
- **Файл:** `src/app/api/analytics/route.ts:44`
- **Ошибка:** `Property 'kaspi_id' does not exist on type 'never'`
- **Причина:** Supabase-запрос возвращает `never` тип — вероятно проблема с типизацией таблицы `products` в `types/database.ts`
- **Как исправить:** Проверить типы в `database.ts` или добавить `as any` / явную типизацию результата запроса
- **Дата исправления:** —

### 2. Middleware аутентификации отключен
- **Статус:** `[ ]` Не исправлено
- **Файл:** `middleware.ts`
- **Проблема:** Все роуты `/app/*` доступны без авторизации. Middleware закомментирован для отладки.
- **Риск:** Любой может зайти в дашборд, заказы, настройки без логина
- **Как исправить:** Включить middleware, настроить редирект на `/login` для неавторизованных
- **Дата исправления:** —

### 3. Админка без проверки ролей
- **Статус:** `[ ]` Не исправлено
- **Файл:** `src/app/admin/layout.tsx`, `src/app/admin/x7k9m2p4q8r1/page.tsx`
- **Проблема:** Админ-панель защищена только обфусцированным URL, нет проверки роли пользователя
- **Риск:** Если URL утечёт — любой получит доступ к управлению пользователями и подписками
- **Как исправить:** Добавить проверку `user.role === 'admin'` в layout.tsx, редирект если не админ
- **Дата исправления:** —

---

## Средние

### 4. Dashboard — гигантский компонент
- **Статус:** `[ ]` Не исправлено
- **Файл:** `src/app/app/page.tsx` (~1179 строк)
- **Проблема:** Вся логика дашборда в одном файле — сложно поддерживать, медленные ре-рендеры
- **Как исправить:** Разбить на компоненты: `DashboardStats`, `DashboardCharts`, `DashboardOrders` и т.д.
- **Дата исправления:** —

### 5. `@neondatabase/serverless` — возможный мусор
- **Статус:** `[ ]` Не проверено
- **Файл:** `package.json`
- **Проблема:** Использовался как адаптер для Prisma. Prisma удалена — нужно проверить, используется ли ещё где-то
- **Как исправить:** Поискать `@neondatabase` в коде. Если нигде — удалить из package.json
- **Дата исправления:** —

### 6. Временные скрипты в корне проекта
- **Статус:** `[ ]` Не исправлено
- **Файлы:** `fix-reviews.js`, `fix-reviews-v2.js`, `cleanup-orphan.js`
- **Проблема:** Одноразовые скрипты засоряют корень проекта
- **Как исправить:** Удалить если больше не нужны, или перенести в `scripts/`
- **Дата исправления:** —

### 7. Папка `sessions/` с Playwright-данными
- **Статус:** `[ ]` Не исправлено
- **Файл:** `sessions/`
- **Проблема:** Может содержать сохранённые cookie Kaspi-сессий. Не в `.gitignore`
- **Как исправить:** Добавить `sessions/` в `.gitignore`, проверить что не попало в git
- **Дата исправления:** —

---

## Мелкие

### 8. Нет тестов
- **Статус:** `[ ]` Не исправлено
- **Проблема:** Ни одного unit/integration теста в проекте
- **Как исправить:** Добавить как минимум тесты для критичных API: sync, analytics, auth
- **Дата исправления:** —

### 9. Незавершённые фичи
- **Статус:** `[ ]` Информация
- **Проблема:** Некоторые фичи имеют UI но не полностью реализованы:
  - WhatsApp-интеграция (инфраструктура есть, интеграция не доделана)
  - Маркетинговые кампании (API частично)
  - Авто-рассылки (UI есть, бэкенд частично)
- **Дата исправления:** —

---

## Исправлено

### ~~Prisma — мёртвый груз~~
- **Статус:** `[x]` Исправлено
- **Дата:** 2026-02-08
- **Что сделано:** Удалены `prisma/`, `src/lib/db/`, зависимости из package.json

### ~~NextAuth — мёртвый груз~~
- **Статус:** `[x]` Исправлено
- **Дата:** 2026-02-08
- **Что сделано:** Удалены `src/app/api/auth/`, `src/types/next-auth.d.ts`, зависимость, env-переменные. Topbar и admin layout переведены на Supabase Auth

### ~~Удалённые docs-файлы в git status~~
- **Статус:** `[x]` Исправлено
- **Дата:** 2026-02-08
- **Что сделано:** 131 файл застейджен на удаление (`git add -u -- docs/`)

### ~~Лишние Vercel env-переменные~~
- **Статус:** `[x]` Исправлено
- **Дата:** 2026-02-08
- **Что сделано:** Удалены NEXTAUTH_SECRET, NEXTAUTH_URL, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
